<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Arcanum: Final Ritual</title>
    <style>
        /* --- å…¨å±€åŸºç¡€æ ·å¼ --- */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #000; 
            font-family: 'Cinzel', 'Noto Serif SC', serif; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent;
        }
        #canvas-container { 
            width: 100vw; 
            height: 100vh; 
            position: absolute; 
            top: 0; 
            left: 0; 
            z-index: 1; 
        }
        
        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;800&family=Noto+Serif+SC:wght@300;500&display=swap');

        /* --- å¯åŠ¨å±å¹• --- */
        #start-screen {
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            z-index: 100;
            background: radial-gradient(circle at center, rgba(10,10,10,0.8) 0%, #000 90%);
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center;
            transition: opacity 1.5s ease; 
            color: #d4af37;
        }

        .title-group { 
            text-align: center; 
            margin-bottom: 40px; 
            animation: floatTitle 6s ease-in-out infinite; 
        }
        
        h1 { 
            font-size: 60px; 
            margin: 0; 
            letter-spacing: 12px; 
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #d4af37 50%, #996515 100%);
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(212,175,55,0.3);
        }
        
        h2 { 
            font-size: 14px; 
            letter-spacing: 6px; 
            color: #888; 
            margin-top: 15px; 
            text-transform: uppercase; 
            border-top: 1px solid rgba(212, 175, 55, 0.3); 
            padding-top: 15px; 
            display: inline-block;
        }

        @keyframes floatTitle { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-10px); } 
        }

        .options-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
            margin-bottom: 40px; 
        }
        
        .choice-btn {
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(212,175,55,0.3); 
            color: #888;
            padding: 12px 24px; 
            border-radius: 50px; 
            cursor: pointer; 
            transition: all 0.3s;
            font-family: inherit;
            font-size: 12px;
            letter-spacing: 1px;
        }
        
        .choice-btn.active { 
            border-color: #d4af37; 
            color: #fff; 
            background: rgba(212,175,55,0.2); 
            box-shadow: 0 0 15px rgba(212,175,55,0.2);
        }

        #enter-btn {
            background: transparent; 
            color: #d4af37; 
            border: 1px solid #d4af37;
            padding: 15px 60px; 
            font-size: 16px; 
            letter-spacing: 6px; 
            border-radius: 50px;
            cursor: pointer; 
            transition: 0.5s; 
            font-weight: bold;
            font-family: inherit;
        }
        
        #enter-btn:hover { 
            background: #d4af37; 
            color: #000; 
            box-shadow: 0 0 40px rgba(212,175,55,0.6); 
        }

        /* --- æ¸¸æˆå†… UI å±‚ --- */
        #ui-layer { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 20; 
            pointer-events: none; 
            opacity: 0; 
            transition: opacity 1.5s; 
        }
        
        /* é¡¶éƒ¨é€‰ä¸­å¡ç‰Œè®°å½• */
        #history-container {
            position: absolute; 
            top: 20px; 
            left: 50%; 
            transform: translateX(-50%);
            display: flex; 
            gap: 15px; 
            pointer-events: auto; 
            z-index: 30;
        }
        
        .history-slot {
            width: 40px; 
            height: 64px; 
            background: #000; 
            border: 1px solid #d4af37; 
            border-radius: 4px;
            overflow: hidden; 
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            animation: slotEnter 0.5s ease;
            position: relative;
        }
        
        .history-slot img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .history-slot.reversed img {
            transform: rotate(180deg);
        }

        @keyframes slotEnter { from {transform:translateY(-20px);opacity:0;} to {transform:translateY(0);opacity:1;} }

        /* åº•éƒ¨æ“ä½œæç¤º */
        #hud-center {
            position: absolute; 
            bottom: 10%; 
            left: 0; 
            width: 100%; 
            text-align: center; 
            color: #d4af37; 
            transition: opacity 0.5s;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }
        
        #gesture-icon { font-size: 32px; display: block; margin-bottom: 8px; opacity: 0.9; }
        #status-text { font-size: 12px; letter-spacing: 3px; font-weight: 600; text-transform: uppercase; }

        /* --- æœ€ç»ˆç»“æœæ–‡å­—å±•ç¤ºåŒº (å…³é”®è°ƒæ•´) --- */
        #final-text-container {
            position: absolute; 
            /* PCç«¯é»˜è®¤ */
            top: 60%; 
            left: 0; 
            width: 100%;
            display: flex; 
            justify-content: center; 
            gap: 40px; 
            text-align: center; 
            opacity: 0; 
            transition: opacity 2s; 
            pointer-events: none;
            padding: 0 20px; 
            box-sizing: border-box;
            flex-wrap: wrap;
        }
        
        .final-card-label { 
            width: 250px; 
            color: #fff; 
            margin-bottom: 15px; 
            text-shadow: 0 2px 10px #000; 
        }
        
        .final-name { 
            color: #d4af37; 
            font-size: 18px; 
            font-weight: bold; 
            border-bottom: 1px solid rgba(212,175,55,0.4); 
            padding-bottom: 5px; 
            margin-bottom: 8px; 
        }
        
        .final-meaning { 
            font-size: 13px; 
            color: #ccc; 
            font-style: italic; 
            line-height: 1.5; 
        }

        /* é‡æ–°å¼€å§‹æŒ‰é’® */
        #end-ui {
            position: absolute; 
            bottom: 30px; 
            width: 100%; 
            text-align: center;
            opacity: 0; 
            transition: opacity 1s; 
            pointer-events: none; 
            z-index: 50;
        }
        
        #restart-btn {
            background: rgba(0,0,0,0.8); 
            border: 1px solid #d4af37; 
            color: #d4af37;
            padding: 12px 40px; 
            border-radius: 30px; 
            letter-spacing: 4px; 
            cursor: pointer;
            backdrop-filter: blur(4px);
            font-family: inherit;
        }

        #credits { 
            position: absolute; 
            bottom: 10px; 
            right: 15px; 
            color: #444; 
            font-size: 10px; 
        }

        #video-feed { position: absolute; bottom: 10px; right: 10px; width: 80px; opacity: 0; transform: scaleX(-1); border: 1px solid #444; }

        /* --- ç§»åŠ¨ç«¯ç‰¹å®šé€‚é… --- */
        @media (max-width: 768px) {
            h1 { font-size: 42px; letter-spacing: 8px; }
            .options-grid { gap: 15px; }
            .choice-btn { padding: 10px 15px; font-size: 11px; }
            
            #history-container { top: 15px; gap: 8px; }
            
            /* ç§»åŠ¨ç«¯ç»“æœé¡µï¼šæ–‡å­—æ”¾åœ¨ä¸‹åŠå± (55%)ï¼Œç‰Œåœ¨ä¸ŠåŠå± */
            #final-text-container { 
                top: 55%; 
                gap: 15px; 
            }
            .final-card-label { 
                width: 100%; 
                max-width: 320px; 
                margin-bottom: 10px; 
            }
            .final-name { font-size: 16px; }
            .final-meaning { font-size: 12px; }
            
            #hud-center { bottom: 15%; }
        }
    </style>
    
    <!-- ä¾èµ–åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>
    <!-- å¯åŠ¨é¡µ -->
    <div id="start-screen">
        <div class="title-group">
            <h1>ARCANUM</h1>
            <h2>The Virtual Ritual</h2>
        </div>
        <div class="options-grid">
            <button class="choice-btn active" id="btn-en" onclick="setLang('en')">English</button>
            <button class="choice-btn" id="btn-zh" onclick="setLang('zh')">ä¸­æ–‡</button>
            <button class="choice-btn" id="btn-hand" onclick="setInput('hand')">Hand âœ‹</button>
            <button class="choice-btn active" id="btn-mouse" onclick="setInput('mouse')">Touch/Mouse ğŸ–±ï¸</button>
        </div>
        <button id="enter-btn" onclick="enterExperience()">ENTER VOID</button>
    </div>

    <!-- UI å±‚ -->
    <div id="ui-layer">
        <div id="history-container"></div>
        <div id="final-text-container"></div>
        <div id="hud-center">
            <span id="gesture-icon">ğŸ–±ï¸</span>
            <div id="status-text">INITIATING...</div>
        </div>
        <div id="end-ui">
            <button id="restart-btn" onclick="location.reload()">RESTART</button>
        </div>
        <div id="credits">Jerry Hu & Gemini</div>
    </div>

    <video id="video-feed" playsinline></video>
    <div id="canvas-container"></div>

<script>
/** * é…ç½®å‚æ•° (CONFIG) 
 * å…³é”®ä¿®æ­£ï¼šç¡®ä¿æ‘„åƒæœºåœ¨ (0,0,0)ï¼Œç‰Œåœ¨ RADIUS å¤„ã€‚
 */
const CONFIG = {
    RADIUS: 6.5,          // åœ†ç¯åŠå¾„
    CARD_W: 1.5,          // å¡ç‰Œå®½
    CARD_H: 2.58,         // å¡ç‰Œé«˜
    CAMERA_Z_IDLE: 0.1,   // æ‘„åƒæœºä½ç½® (å‡ è¿‘äº0ï¼Œä½äºåœ†å¿ƒ)
    
    // ç§»åŠ¨ç«¯ç»“æœå±•ç¤ºå‚æ•° (æ‹‰è¿‘è·ç¦»ï¼Œè°ƒé«˜ä½ç½®)
    FINAL_Z_MOBILE: -2.8, 
    FINAL_Y_MOBILE: 0.8,  
    
    // PCç«¯ç»“æœå±•ç¤ºå‚æ•°
    FINAL_Z_PC: -4.5,     
    FINAL_Y_PC: 0,
    
    MOBILE_FOV: 80        // ç§»åŠ¨ç«¯å¹¿è§’ï¼Œå¢å¼ºæ²‰æµ¸æ„Ÿ
};

const TEXTS = {
    en: { statusWave: "Wave/Drag to Look", statusPinch: "Pinch/Tap to Select", statusRev: "Reversed", statusDone: "Destiny Revealed" },
    zh: { statusWave: "æŒ¥æ‰‹ / æ»‘åŠ¨è§†è§’", statusPinch: "æåˆ / ç‚¹å‡»é€‰ä¸­", statusRev: "é€†ä½", statusDone: "å‘½è¿å·²æ­ç¤º" }
};

// çŠ¶æ€å˜é‡
let lang = 'en';
let inputMode = 'mouse';
const isMobile = /Android|iPhone|iPad/i.test(navigator.userAgent);
if(isMobile) inputMode = 'mouse'; // ç§»åŠ¨ç«¯å¼ºåˆ¶é»˜è®¤è§¦æ‘¸

let scene, camera, renderer;
let deckGroup; 
let cards = [];
let stars;
let isStarted = false;
let isFinished = false;

// äº¤äº’å˜é‡
let rotVelocity = 0;
let targetRotation = 0;
let selectedCards = [];
let isPinching = false;

// å¡”ç½—ç‰Œæ•°æ® (å®Œæ•´22å¼ å¤§é˜¿å¡çº³)
const TAROT_DATA = [
    {id:0, en:"The Fool", zh:"æ„šè€…", desc_en:"New beginnings, innocence, spontaneity", desc_zh:"æ–°çš„å¼€å§‹ï¼Œå¤©çœŸï¼Œå†’é™©ï¼Œæ— é™å¯èƒ½"},
    {id:1, en:"The Magician", zh:"é­”æœ¯å¸ˆ", desc_en:"Manifestation, resourcefulness, power", desc_zh:"åˆ›é€ åŠ›ï¼Œèµ„æºï¼Œæ„å¿—åŠ›ï¼Œæ˜¾åŒ–"},
    {id:2, en:"High Priestess", zh:"å¥³ç¥­å¸", desc_en:"Intuition, sacred knowledge, mystery", desc_zh:"ç›´è§‰ï¼Œæ½œæ„è¯†ï¼Œç¥ç§˜çŸ¥è¯†ï¼Œæ™ºæ…§"},
    {id:3, en:"The Empress", zh:"çš‡å", desc_en:"Femininity, beauty, nature, nurturing", desc_zh:"ä¸°é¥¶ï¼Œæ¯æ€§ï¼Œè‡ªç„¶ï¼Œæ„Ÿå®˜äº«å—"},
    {id:4, en:"The Emperor", zh:"çš‡å¸", desc_en:"Authority, establishment, structure", desc_zh:"æƒå¨ï¼Œç»“æ„ï¼Œæ§åˆ¶ï¼Œçˆ¶æ€§åŠ›é‡"},
    {id:5, en:"The Hierophant", zh:"æ•™çš‡", desc_en:"Spiritual wisdom, religious beliefs", desc_zh:"ä¼ ç»Ÿï¼Œä¿¡ä»°ï¼Œç²¾ç¥æŒ‡å¼•ï¼Œæ•™å¯¼"},
    {id:6, en:"The Lovers", zh:"æ‹äºº", desc_en:"Love, harmony, relationships", desc_zh:"çˆ±ï¼Œå’Œè°ï¼Œç»“åˆï¼Œé€‰æ‹©"},
    {id:7, en:"The Chariot", zh:"æˆ˜è½¦", desc_en:"Control, willpower, success, action", desc_zh:"æ„å¿—åŠ›ï¼Œèƒœåˆ©ï¼Œå†³å¿ƒï¼ŒæŒæ§"},
    {id:8, en:"Strength", zh:"åŠ›é‡", desc_en:"Strength, courage, persuasion", desc_zh:"å†…åœ¨åŠ›é‡ï¼Œå‹‡æ°”ï¼Œè€å¿ƒï¼Œä»¥æŸ”å…‹åˆš"},
    {id:9, en:"The Hermit", zh:"éšå£«", desc_en:"Soul-searching, introspection, being alone", desc_zh:"å†…çœï¼Œå­¤ç‹¬ï¼Œå¯»æ‰¾çœŸç†ï¼ŒæŒ‡å¼•"},
    {id:10, en:"Wheel of Fortune", zh:"å‘½è¿ä¹‹è½®", desc_en:"Good luck, karma, life cycles", desc_zh:"å‘½è¿è½¬æŠ˜ï¼Œå› æœï¼Œæœºé‡ï¼Œæ”¹å˜"},
    {id:11, en:"Justice", zh:"æ­£ä¹‰", desc_en:"Justice, fairness, truth, cause and effect", desc_zh:"å…¬æ­£ï¼ŒçœŸç†ï¼Œå› æœï¼Œæ³•å¾‹"},
    {id:12, en:"Hanged Man", zh:"å€’åŠäºº", desc_en:"Pause, surrender, letting go", desc_zh:"ç‰ºç‰²ï¼Œæ¢ä½æ€è€ƒï¼Œç­‰å¾…ï¼Œæ”¾æ‰‹"},
    {id:13, en:"Death", zh:"æ­»ç¥", desc_en:"Endings, change, transformation", desc_zh:"ç»“æŸï¼Œé‡ç”Ÿï¼Œå½»åº•çš„æ”¹å˜"},
    {id:14, en:"Temperance", zh:"èŠ‚åˆ¶", desc_en:"Balance, moderation, patience", desc_zh:"å¹³è¡¡ï¼Œè°ƒå’Œï¼Œè€å¿ƒï¼Œä¸­åº¸"},
    {id:15, en:"The Devil", zh:"æ¶é­”", desc_en:"Shadow self, attachment, addiction", desc_zh:"æŸç¼šï¼Œæ¬²æœ›ï¼Œç‰©è´¨ä¸»ä¹‰ï¼Œæ²‰è¿·"},
    {id:16, en:"The Tower", zh:"é«˜å¡”", desc_en:"Sudden change, upheaval, chaos", desc_zh:"çªå˜ï¼Œæ¯ç­ï¼Œå¯ç¤ºï¼Œå´©å¡Œ"},
    {id:17, en:"The Star", zh:"æ˜Ÿæ˜Ÿ", desc_en:"Hope, faith, purpose, renewal", desc_zh:"å¸Œæœ›ï¼Œçµæ„Ÿï¼Œæ²»æ„ˆï¼Œæœªæ¥"},
    {id:18, en:"The Moon", zh:"æœˆäº®", desc_en:"Illusion, fear, anxiety, subconscious", desc_zh:"å¹»è§‰ï¼Œä¸å®‰ï¼Œæ½œæ„è¯†ï¼Œè¿·èŒ«"},
    {id:19, en:"The Sun", zh:"å¤ªé˜³", desc_en:"Positivity, fun, warmth, success", desc_zh:"æˆåŠŸï¼Œå¿«ä¹ï¼Œæ´»åŠ›ï¼Œå…‰æ˜"},
    {id:20, en:"Judgement", zh:"å®¡åˆ¤", desc_en:"Judgement, rebirth, inner calling", desc_zh:"è§‰é†’ï¼Œå¤æ´»ï¼Œå› æœè£å†³ï¼Œå‘¼å”¤"},
    {id:21, en:"The World", zh:"ä¸–ç•Œ", desc_en:"Completion, integration, accomplishment", desc_zh:"åœ†æ»¡ï¼Œå®Œæˆï¼Œæˆå°±ï¼Œæ—…ç¨‹ç»ˆç‚¹"}
];

// UI è®¾ç½®å‡½æ•°
function setLang(l) { 
    lang = l; 
    document.getElementById('btn-en').className = l==='en'?'choice-btn active':'choice-btn';
    document.getElementById('btn-zh').className = l==='zh'?'choice-btn active':'choice-btn';
    updateHUD();
}
function setInput(m) {
    inputMode = m;
    document.getElementById('btn-hand').className = m==='hand'?'choice-btn active':'choice-btn';
    document.getElementById('btn-mouse').className = m==='mouse'?'choice-btn active':'choice-btn';
}

function enterExperience() {
    isStarted = true;
    document.getElementById('start-screen').style.opacity = 0;
    setTimeout(() => document.getElementById('start-screen').style.display = 'none', 1500);
    document.getElementById('ui-layer').style.opacity = 1;
    
    initThree();
    if(inputMode === 'hand') initHandTracking();
    else initMouseTouch();
    
    updateHUD();
}

function updateHUD() {
    const t = TEXTS[lang];
    const status = document.getElementById('status-text');
    const icon = document.getElementById('gesture-icon');
    
    if(isFinished) {
        status.innerText = t.statusDone;
        icon.innerText = "âœ¨";
    } else {
        status.innerText = inputMode==='hand' ? t.statusWave : t.statusWave;
        icon.innerText = inputMode==='hand' ? "âœ‹" : (isMobile ? "ğŸ‘†" : "ğŸ–±ï¸");
    }
}

// --- THREE.JS æ ¸å¿ƒé€»è¾‘ ---

function initThree() {
    scene = new THREE.Scene();
    scene.fog = new THREE.FogExp2(0x000000, 0.025); // å¢åŠ é›¾æ°”ï¼Œå¢å¼ºç¥ç§˜æ„Ÿ

    // æ‘„åƒæœºè®¾ç½®
    const fov = isMobile ? CONFIG.MOBILE_FOV : 60; 
    camera = new THREE.PerspectiveCamera(fov, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    // å¼ºåˆ¶å½’é›¶ï¼šç¡®ä¿ç©å®¶ä½äºåœ†å¿ƒ
    camera.position.set(0, 0, CONFIG.CAMERA_Z_IDLE); 
    camera.lookAt(0, 0, -1);

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    // ç¯å…‰
    const amb = new THREE.AmbientLight(0xffffff, 0.6);
    scene.add(amb);
    const dir = new THREE.DirectionalLight(0xffd700, 0.8);
    dir.position.set(0, 2, 0); 
    scene.add(dir);

    // æ˜Ÿç©ºèƒŒæ™¯
    createStars();

    // åˆ›å»ºç‰Œç»„
    deckGroup = new THREE.Group();
    scene.add(deckGroup);
    createDeck();

    animate();
    window.addEventListener('resize', onResize);
}

function createStars() {
    const geo = new THREE.BufferGeometry();
    const pos = [];
    for(let i=0; i<2000; i++) {
        const r = 20 + Math.random() * 40;
        const theta = Math.random() * Math.PI * 2;
        const phi = Math.acos(2 * Math.random() - 1);
        pos.push(r*Math.sin(phi)*Math.cos(theta), r*Math.sin(phi)*Math.sin(theta), r*Math.cos(phi));
    }
    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
    stars = new THREE.Points(geo, new THREE.PointsMaterial({color: 0xffffff, size: 0.12, transparent: true, opacity: 0.8}));
    scene.add(stars);
}

function createDeck() {
    const loader = new THREE.TextureLoader();
    const backTex = loader.load('https://i.imgur.com/7v8vO4H.jpeg'); 
    const geo = new THREE.PlaneGeometry(CONFIG.CARD_W, CONFIG.CARD_H);
    
    // æ´—ç‰Œ
    const indices = Array.from({length: 22}, (_, i) => i).sort(()=>Math.random()-0.5);
    const angleStep = (Math.PI * 2) / 22;

    for(let i=0; i<22; i++) {
        const id = indices[i];
        const data = TAROT_DATA[id];
        
        // ä½¿ç”¨ Wiki èµ„æºç¡®ä¿èƒ½åŠ è½½
        const url = `https://upload.wikimedia.org/wikipedia/commons/thumb/${getWikiPath(id)}`;
        
        const matFront = new THREE.MeshBasicMaterial({ 
            map: loader.load(url),
            side: THREE.FrontSide
        });
        const matBack = new THREE.MeshBasicMaterial({ map: backTex, side: THREE.BackSide }); 
        
        // å¡ç‰Œç»„
        const cGroup = new THREE.Group();
        
        // æ­£é¢ Mesh (Face)
        // æ—‹è½¬180åº¦ï¼Œä½¿å…¶èƒŒå¯¹åœ†å¿ƒ (åˆå§‹çŠ¶æ€ä¸å¯è§)
        const mFront = new THREE.Mesh(geo, matFront);
        mFront.rotation.y = Math.PI; 
        mFront.position.z = -0.01;
        
        // èƒŒé¢ Mesh (Back)
        // é¢å‘åœ†å¿ƒï¼Œç©å®¶å¯è§
        const mBack = new THREE.Mesh(geo, matBack);
        mBack.rotation.y = 0; 
        mBack.position.z = 0.01;
        
        cGroup.add(mFront);
        cGroup.add(mBack);
        
        // ç¯å½¢åˆ†å¸ƒ
        const theta = i * angleStep;
        cGroup.position.x = CONFIG.RADIUS * Math.sin(theta);
        cGroup.position.z = -CONFIG.RADIUS * Math.cos(theta);
        
        // æœå‘åœ†å¿ƒ (LookAt 0,0,0)
        cGroup.lookAt(0, 0, 0); 
        
        cGroup.userData = { id: id, data: data, theta: theta, isSelected: false };
        cards.push(cGroup);
        deckGroup.add(cGroup);
    }
}

// Wiki å›¾ç‰‡æ˜ å°„è¾…åŠ©å‡½æ•°
function getWikiPath(id) {
    const files = [
        "9/90/RWS_Tarot_00_Fool.jpg", "d/de/RWS_Tarot_01_Magician.jpg", "8/88/RWS_Tarot_02_High_Priestess.jpg",
        "d/d2/RWS_Tarot_03_Empress.jpg", "c/c3/RWS_Tarot_04_Emperor.jpg", "8/8d/RWS_Tarot_05_Hierophant.jpg",
        "3/3a/RWS_Tarot_06_Lovers.jpg", "9/9b/RWS_Tarot_07_Chariot.jpg", "f/f5/RWS_Tarot_08_Strength.jpg",
        "4/4d/RWS_Tarot_09_Hermit.jpg", "3/3c/RWS_Tarot_10_Wheel_of_Fortune.jpg", "e/e0/RWS_Tarot_11_Justice.jpg",
        "2/2b/RWS_Tarot_12_Hanged_Man.jpg", "d/d7/RWS_Tarot_13_Death.jpg", "f/f8/RWS_Tarot_14_Temperance.jpg",
        "5/55/RWS_Tarot_15_Devil.jpg", "5/53/RWS_Tarot_16_Tower.jpg", "d/db/RWS_Tarot_17_Star.jpg",
        "7/7f/RWS_Tarot_18_Moon.jpg", "1/17/RWS_Tarot_19_Sun.jpg", "d/dd/RWS_Tarot_20_Judgement.jpg",
        "f/ff/RWS_Tarot_21_World.jpg"
    ];
    return files[id] + "/300px-" + files[id].split('/').pop();
}

// --- äº¤äº’é€»è¾‘ ---

function initMouseTouch() {
    let startX = 0;
    let isDragging = false;
    
    // Mouse
    document.addEventListener('mousedown', e => { startX = e.clientX; isDragging = true; });
    document.addEventListener('mousemove', e => {
        if(isDragging) {
            const dx = e.clientX - startX;
            targetRotation += dx * 0.005;
            startX = e.clientX;
        }
        updateRaycaster((e.clientX/window.innerWidth)*2-1, -(e.clientY/window.innerHeight)*2+1);
    });
    document.addEventListener('mouseup', e => {
        isDragging = false;
        if(hoveredCard) selectCard(hoveredCard);
    });

    // Touch (Mobile)
    document.addEventListener('touchstart', e => { 
        startX = e.touches[0].clientX; 
        isDragging = true; 
    }, {passive: false});
    
    document.addEventListener('touchmove', e => {
        if(isDragging) {
            const dx = e.touches[0].clientX - startX;
            targetRotation += dx * 0.008; // ç§»åŠ¨ç«¯æ—‹è½¬çµæ•åº¦
            startX = e.touches[0].clientX;
        }
    }, {passive: false});
    
    document.addEventListener('touchend', e => {
        isDragging = false;
        // ç‚¹å‡»/åœæ­¢è§¦æ‘¸æ—¶æ£€æµ‹ä¸­å¿ƒå¡ç‰Œ
        checkCenterSelection();
    });
}

function initHandTracking() {
    const video = document.getElementById('video-feed');
    const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5});
    hands.onResults(results => {
        if(results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
            const lm = results.multiHandLandmarks[0];
            const x = lm[9].x; 
            
            // æ‰‹åŠ¿æ—‹è½¬
            if(x < 0.3) targetRotation += 0.03;
            if(x > 0.7) targetRotation -= 0.03;
            
            // æåˆé€‰æ‹©
            const pinchDist = Math.hypot(lm[8].x - lm[4].x, lm[8].y - lm[4].y);
            if(pinchDist < 0.05) {
                if(!isPinching) { isPinching = true; checkCenterSelection(); }
            } else {
                isPinching = false;
            }
        }
    });
    const cam = new Camera(video, {onFrame: async()=>{await hands.send({image:video})}, width:320, height:240});
    cam.start();
    video.style.opacity = 0.3;
}

// å°„çº¿æ£€æµ‹
const raycaster = new THREE.Raycaster();
let hoveredCard = null;

function updateRaycaster(x, y) {
    raycaster.setFromCamera(new THREE.Vector2(x, y), camera);
    const intersects = raycaster.intersectObjects(deckGroup.children, true);
    if(intersects.length > 0) {
        let obj = intersects[0].object;
        while(obj.parent !== deckGroup) obj = obj.parent;
        hoveredCard = obj;
        document.body.style.cursor = 'pointer';
    } else {
        hoveredCard = null;
        document.body.style.cursor = 'default';
    }
}

function checkCenterSelection() {
    if(isFinished) return;
    
    // å¯»æ‰¾ç¦»æ‘„åƒæœºæ­£å‰æ–¹æœ€è¿‘çš„ç‰Œ (0,0, -R)
    let best = null;
    let minD = Infinity;
    
    cards.forEach(c => {
        if(c.userData.isSelected) return;
        const worldPos = new THREE.Vector3();
        c.getWorldPosition(worldPos);
        const d = worldPos.distanceTo(new THREE.Vector3(0,0,-CONFIG.RADIUS));
        if(d < minD) { minD = d; best = c; }
    });
    
    // åˆ¤å®šé˜ˆå€¼æ”¾å®½ï¼Œä¾¿äºé€‰ä¸­
    if(best && minD < 2.5) { 
        selectCard(best);
    }
}

function selectCard(card) {
    if(selectedCards.length >= 3 || card.userData.isSelected) return;
    
    card.userData.isSelected = true;
    selectedCards.push(card);
    
    // åŠ¨ç”»ï¼šå¡ç‰Œé£åˆ°é¢å‰
    scene.attach(card); // ä»åœ†ç¯ç»„ä¸­åˆ†ç¦»
    
    const targetPos = new THREE.Vector3(0, 0, -2); 
    const isRev = Math.random() < 0.3; // 30% é€†ä½æ¦‚ç‡
    card.userData.isRev = isRev;
    
    // ä½ç½®åŠ¨ç”»
    new TWEEN.Tween(card.position).to(targetPos, 800).easing(TWEEN.Easing.Cubic.Out).start();
    
    // æ—‹è½¬åŠ¨ç”»ï¼šç¿»è½¬åˆ°æ­£é¢
    // åˆå§‹çŠ¶æ€ï¼šèƒŒå¯¹åœ†å¿ƒ(Local Z-)ã€‚é¢å‘åœ†å¿ƒçš„æ˜¯èƒŒé¢(Local Z+)ã€‚
    // ç›®æ ‡ï¼šæ­£é¢æœå‘æ‘„åƒæœºã€‚
    // ç®€å•å¤„ç†ï¼šå°†å¡ç‰Œæ—‹è½¬å½’é›¶ (LookAt World -Z)ï¼Œç„¶åç»• Z è½´æ—‹è½¬å¤„ç†é€†ä½
    new TWEEN.Tween(card.rotation)
        .to({x: 0, y: Math.PI, z: isRev ? Math.PI : 0}, 800) 
        .onComplete(() => {
            // æ·»åŠ åˆ°é¡¶éƒ¨ UI
            addToHistoryUI(card);
            // ç¼©å°æ¶ˆå¤±
            new TWEEN.Tween(card.scale).to({x:0, y:0, z:0}, 500).start();
            
            if(selectedCards.length === 3) finishRitual();
        }).start();
}

function addToHistoryUI(card) {
    const container = document.getElementById('history-container');
    const div = document.createElement('div');
    div.className = 'history-slot' + (card.userData.isRev ? ' reversed' : '');
    const img = document.createElement('img');
    img.src = `https://upload.wikimedia.org/wikipedia/commons/thumb/${getWikiPath(card.userData.id)}`;
    div.appendChild(img);
    container.appendChild(div);
}

function finishRitual() {
    isFinished = true;
    updateHUD();
    
    // éšè—å‰©ä½™ç‰Œå †
    new TWEEN.Tween(deckGroup.scale).to({x:0, y:0, z:0}, 1000).start();
    
    // å±•ç¤ºç»“æœ
    setTimeout(() => {
        const finalText = document.getElementById('final-text-container');
        finalText.style.opacity = 1;
        document.getElementById('end-ui').style.opacity = 1;
        document.getElementById('end-ui').style.pointerEvents = 'auto';
        
        selectedCards.forEach((c, i) => {
            c.visible = true;
            c.scale.set(0,0,0);
            
            // å…³é”®ï¼šæœ€ç»ˆä½ç½®è®¡ç®—
            // ç§»åŠ¨ç«¯ï¼šæ‹‰å¾—å¾ˆè¿‘ (-2.8)ï¼Œæ”¾å¾—ç•¥é«˜ (0.8)
            const zPos = isMobile ? CONFIG.FINAL_Z_MOBILE : CONFIG.FINAL_Z_PC;
            const yPos = isMobile ? CONFIG.FINAL_Y_MOBILE : CONFIG.FINAL_Y_PC;
            
            // æ°´å¹³æ’åˆ—é—´è·
            const gap = isMobile ? 1.0 : 1.8;
            const xPos = (i - 1) * gap;
            
            new TWEEN.Tween(c.position)
                .to({x: xPos, y: yPos, z: zPos}, 1500)
                .easing(TWEEN.Easing.Elastic.Out)
                .delay(i*200)
                .start();
                
            new TWEEN.Tween(c.scale)
                .to({x:1, y:1, z:1}, 1500)
                .delay(i*200)
                .start();
                
            // æ·»åŠ æ–‡å­—æè¿°
            const tDiv = document.createElement('div');
            tDiv.className = 'final-card-label';
            const name = lang==='zh'?c.userData.data.zh:c.userData.data.en;
            const desc = lang==='zh'?c.userData.data.desc_zh:c.userData.data.desc_en;
            const revStr = c.userData.isRev ? ` (${TEXTS[lang].statusRev})` : "";
            
            tDiv.innerHTML = `<div class="final-name">${name}${revStr}</div><div class="final-meaning">${desc}</div>`;
            finalText.appendChild(tDiv);
        });
    }, 1000);
}

function animate() {
    requestAnimationFrame(animate);
    TWEEN.update();
    
    if(!isFinished) {
        // æƒ¯æ€§æ—‹è½¬
        deckGroup.rotation.y += (targetRotation - deckGroup.rotation.y) * 0.1;
        // ç¼“æ…¢è‡ªè½¬
        targetRotation += 0.0005;
        // æ˜Ÿç©ºæ—‹è½¬
        if(stars) stars.rotation.y += 0.0003;
    }
    
    renderer.render(scene, camera);
}

function onResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
    // å§‹ç»ˆä¿æŒæ‘„åƒæœºå½’é›¶
    camera.position.set(0, 0, CONFIG.CAMERA_Z_IDLE);
}

</script>
</body>
</html>
